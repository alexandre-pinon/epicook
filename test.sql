      WITH recipe_ingredients AS ( SELECT recipe_id, COALESCE( json_agg( json_build_object( 'id', id, 'recipe_id', recipe_id, 'name', name, 'quantity', quantity, 'unit', unit)) FILTER (WHERE id IS NOT NULL), '[]') AS ingredients FROM ingredients WHERE recipe_id = 'ff379615-c36c-4e23-8e4a-6aa0f0127406' GROUP BY recipe_id), recipe_instructions AS ( SELECT recipe_id, COALESCE( json_agg( json_build_object( 'id', id, 'recipe_id', recipe_id, 'step_number', step_number, 'instruction', instruction) ORDER BY step_number) FILTER (WHERE id IS NOT NULL), '[]') AS instructions FROM instructions WHERE recipe_id = 'ff379615-c36c-4e23-8e4a-6aa0f0127406' GROUP BY recipe_id) SELECT r.id, r.user_id, r.title, r.prep_time, r.cook_time, r.servings, r.source_url, r.image_url, r.cuisine_type, r.rating, COALESCE(ring.ingredients, '[]') as ingredients, COALESCE(rins.instructions, '[]') as instructions FROM recipes r LEFT JOIN recipe_ingredients ring ON r.id = ring.recipe_id LEFT JOIN recipe_instructions rins ON r.id = rins.recipe_id WHERE r.id = 'ff379615-c36c-4e23-8e4a-6aa0f0127406' AND r.user_id = 'fe30769b-7d2f-41d5-84a3-af659d29ff7f'
